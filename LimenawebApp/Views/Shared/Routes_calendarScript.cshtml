
@{
    Layout = null;
}

<script>
    var lastfilter = [];
    var allEvents = [];
    allEvents = @Html.Raw(ViewBag.calroutes);
    var flag = 0;
    var nothinge = [];
    (function ($) {
        'use strict';
        $(function () {
            var style = getComputedStyle(document.body);
            var today = new Date();
            today.setHours(0, 0, 0, 0);

            if ($('#calendar').length) {
                $('#calendar').fullCalendar({
                    header: {
                        left: '',
                        center: 'title',
                        //right: 'month'
                       // right: 'month,listWeek,listDay'
                    },
                    views: {
                       // month: { buttonText: 'Month' }
                        //listWeek: { buttonText: 'list week' },
                        //listDay: { buttonText: 'list day' }
                    },

                    defaultDate: today,
                    navLinks: false, // can click day/week names to navigate views
                    editable: true,
                    disableResizing: true,

                    viewRender: function (view, element) {
                        //console.log(view.start, view.end);
                        //console.log($('#calendar').fullCalendar('getDate'));
                        //console.log($('#calendar').fullCalendar('getView').intervalStart)
                        //console.log($('#calendar').fullCalendar('getView').intervalEnd)

                        var ndate = new Date($('#calendar').fullCalendar('getView').intervalStart); //Evaluar si le sumaremos un dia
                        var fdate = new Date($('#calendar').fullCalendar('getView').intervalEnd);


                        //var lastevents = $('#calendar').fullCalendar('clientEvents');

                    
                        if (flag == 0) {
                            flag = 1;
                            lastfilter.push({
                                sd: ndate,
                                ed: fdate
                            });
                            //console.log("no cargue nada porque es primera vez");
                          
                        } else {

                            var editp = lastfilter.filter(function (el) {
     
                                return el.sd.getTime() === ndate.getTime();
                            });

           

                            if (editp.length > 0) {
                                //console.log("estos eventos ya fueron cargados");
                            } else {
                                lastfilter.push({
                                    sd: ndate,
                                    ed: fdate
                                });

                                document.getElementById("loader").style.display = "block";
                                $.ajax
                                    ({
                                        url: '/Commercial/GetEvents',
                                        type: 'POST',
                                        datatype: 'application/json',
                                        contentType: 'application/json',
                                        data: JSON.stringify({
                                            startf: ndate,
                                            endf: fdate
                                        }),
                                        success: function (result) {

                                            $.each($.parseJSON(result), function (i, events) {
                                                //IF EXISTE

                                                //ELSE
                                                var event = { id: events.id, title: events.title, start: events.start, end: events.end, className: ".fc-event" };

                                                $('#calendar').fullCalendar('renderEvent', event, true);
                                            }

                                            ) //END EACH
                                            document.getElementById("loader").style.display = "none";

                                        },
                                        error: function () {
                                            alert("Whooaaa! Something went wrong..")
                                            document.getElementById("loader").style.display = "none";
                                        },
                                    });
                            }


                        }


                    },

                    //showNonCurrentDates: false,
                    eventLimit: true, // allow "more" link when too many events
                    events: allEvents,
                    eventDrop: function (event, delta, revertFunc) {

                        //alert("You change the date for the Route: " + event.title + ". The new date is: " + event.start.format());

                        if (!confirm("Are you sure about this change? All visits will change to the assigned date.")) {
                            revertFunc();
                        } else {
                            //Hacemos el callback del procedimiento que cambiara todas las fechas
                            
                        var id_route = event.title.substr(0, event.title.indexOf(' '));

                        //Guardamos en server
                        $("#loading").show();
                            $.ajax({
                                url: '/Commercial/ChangeDates',
                                type: 'POST',
                                data: { 'route': id_route, 'nuevafecha': event.start.format() },
                            cache: false,
                            global: false,
                            success: function (result) {
                                $("#loading").hide();

                                if (result.result == "success") {
                                    toastr.success("Data saved successfully.", "Success");
                                } else {
                                    revertFunc();
                                    toastr.warning(result.result, "Warning");
                                }

                            },
                            error: function (request) {
                                $("#loading").hide();
                                revertFunc();

                            }
                        });
                        }

                    },
                    eventAfterRender: function (event, element, view) {
                        //element.css("background", "#fff");
                        //element.css("border-color", "#000 !important");
                        element.css("font-size", "10px");
                        //element.css("border", "solid !important");
                    },
                    eventResize: function (event, delta, revertFunc) {
                        revertFunc();
                        //alert(event.title + "start: " + event.start.format() + " end is now " + event.end.format());

                        //if (!confirm("is this okay?")) {
                        //    revertFunc();
                        //}

                    },

                    eventClick: function (calEvent, jsEvent, view) {

                        //Llamamos con AJAX

                        var id_route = calEvent.title.substr(0, calEvent.title.indexOf(' '));

                        //Guardamos en server
                        $("#loading").show();
                        $.ajax({
                            url: '/Commercial/GetVisits',
                            type: 'GET',
                            data: { 'id': id_route },
                            cache: false,
                            global: false,
                            success: function (result) {
                                $("#loading").hide();

                                var count = 0;
                                var theDiv = document.getElementById("appendDivVisits");
                                var theDivReps = document.getElementById("appendDivReps");
                                theDiv.innerHTML = "";
                                theDivReps.innerHTML = "";

                                var porcentaje = result.porcentaje;
                                var url = '<a class="text-muted" href="#">' + calEvent.title + '</a>';
                                url = url.replace('IDDERUTA', id_route);

                                document.getElementById("nameofroute").innerHTML = url;
                                document.getElementById("porcentajeroute").innerHTML = (Math.round(porcentaje * 100) / 100) + "%";
                                $("#progressbarroute").css("width", (Math.round(porcentaje * 100) / 100) + "%");

                                var contents = '';
                                $.each($.parseJSON(result.result), function (i, visitas) {
                                    count++;
                                    contents = '<div class="item-wrapper d-flex pb-4 border-bottom">';

                                    if (visitas.visitstate == 1) { //Cancelado
                                        contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-danger rounded-circle p-1 mt-2 mx-auto"></span></div>';
                                    } else if (visitas.visitstate == 2) { // En progreso
                                        contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-success rounded-circle p-1 mt-2 mx-auto"></span></div>';
                                    } else if (visitas.visitstate == 3) { //Agendado
                                        contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-warning rounded-circle p-1 mt-2 mx-auto"></span></div>';
                                    } else { //Finalizado
                                        contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-primary rounded-circle p-1 mt-2 mx-auto"></span></div>';

                                    }

                                    //var url = '@Url.Action("Detailsa", "VisitsMs", new { id= "idvisit"})';
                                  
                                    //url = url.replace('idvisit', visitas.id);

                                    contents += '<div class="text-wrapper"><h6 class="d-block mb-1"><a href="' + "#" + '" class="text-muted">' + visitas.store + ' </a></h6><small class="text-gray d-block">' + visitas.address + '</small></div>';
                                    contents += '</div>';

                                    theDiv.innerHTML += contents;
                                });

                                var contentReps = "";
                                contentReps = '<div class="item-wrapper d-flex pb-4 border-bottom">';
                                $.each($.parseJSON(result.result2), function (i, reps) {
                                    
                                    contentReps += '<div class="text-wrapper"><h6 class="d-block mb-1"><a href="' + "#" + '" class="text-muted">' + reps.Name + " " + reps.LastName + ' </a></h6></div>';
                                   
                                });
                                contentReps += '</div>';
                                theDivReps.innerHTML += contentReps;

                                contents = '';
                                contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-danger rounded-circle p-1 mt-2 "></span>&nbsp; Canceled</div>';
                                contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-success rounded-circle p-1 mt-2 "></span>&nbsp; In progress</div>';
                                contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-warning rounded-circle p-1 mt-2 "></span>&nbsp; Scheduled</div>';
                                contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-primary rounded-circle p-1 mt-2 "></span>&nbsp; Finished</div>';
                                contents += '<hr>';
                   
                                theDiv.innerHTML += contents;
                                var theDivcount = document.getElementById("countVisits");
                                theDivcount.innerHTML = count;

                                $('#idroutedel').data('IDr', id_route); //setter
                                $('#idrouteedit').data('IDr', id_route); 
                                $('#idrouteedit').data('RepeatM', result.sel); 
                            },
                            error: function (request) {
                                $("#loading").hide();


                            }
                        });
                        $("#hiddenDiv").css("display", "block");
                        // change the border color just for fun
                        $(".fc-h-event").css("border-color", "#eef2f5 !important");
                        $(".fc-h-event").css("background", "#eef2f5");
                        $(this).css("background", "#00ce68");
                    }


                })
            }
        });
    })(jQuery);



</script>


