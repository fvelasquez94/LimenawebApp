
@{
    Layout = null;
}

<script>
    window.mobilecheck = function () {
        var check = false;
        (function (a) { if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true; })(navigator.userAgent || navigator.vendor || window.opera);
        return check;
    };

    var lastfilter = [];
    var allEvents = [];
    allEvents = @Html.Raw(ViewBag.calroutes);
    var flag = 0;
    var nothinge = [];
    (function ($) {
        'use strict';
        $(function () {
            var style = getComputedStyle(document.body);
            var today = new Date();
            today.setHours(0, 0, 0, 0);

            if ($('#calendar').length) {
                $('#calendar').fullCalendar({
                    header: {
                        left: 'month,listDay',
                        center: 'title',
                        //right: 'month'
                       // right: 'month,listWeek,listDay'
                    },
                    views: {
                       month: { buttonText: 'Month' },
                        //listWeek: { buttonText: 'list week' },
                       listDay: { buttonText: 'list day' }
                    },
                    defaultView: window.mobilecheck() ? "listDay" : "month",
                    defaultDate: today,
                    navLinks: true, // can click day/week names to navigate views
                    editable: true,
                    disableResizing: true,

                    viewRender: function (view, element) {
                        //console.log(view.start, view.end);
                        //console.log($('#calendar').fullCalendar('getDate'));
                        //console.log($('#calendar').fullCalendar('getView').intervalStart)
                        //console.log($('#calendar').fullCalendar('getView').intervalEnd)
                        if (view.name === 'listDay') {
                            //view.el.find('.fc-widget-header').append('<span>&raquo; My Text</span>');//Para poner titulo al lado de nombre de dia de semana

                        } else {
                        var ndate = new Date($('#calendar').fullCalendar('getView').intervalStart); //Evaluar si le sumaremos un dia
                        var fdate = new Date($('#calendar').fullCalendar('getView').intervalEnd);


                        //var lastevents = $('#calendar').fullCalendar('clientEvents');


                        if (flag == 0) {
                            flag = 1;
                            lastfilter.push({
                                sd: ndate,
                                ed: fdate
                            });
                            //console.log("no cargue nada porque es primera vez");

                        } else {

                            var editp = lastfilter.filter(function (el) {

                                return el.sd.getTime() === ndate.getTime();
                            });



                            if (editp.length > 0) {
                                //console.log("estos eventos ya fueron cargados");
                            } else {
                                lastfilter.push({
                                    sd: ndate,
                                    ed: fdate
                                });

                                document.getElementById("loader").style.display = "block";
                                $.ajax
                                    ({
                                        url: '/Commercial/GetEvents',
                                        type: 'POST',
                                        datatype: 'application/json',
                                        contentType: 'application/json',
                                        data: JSON.stringify({
                                            startf: ndate,
                                            endf: fdate
                                        }),
                                        success: function (result) {

                                            $.each($.parseJSON(result), function (i, events) {
                                                //IF EXISTE

                                                //ELSE
                                                var event = { id: events.id, title: events.title, start: events.start, end: events.end, className: ".fc-event" };

                                                $('#calendar').fullCalendar('renderEvent', event, true);
                                            }

                                            ) //END EACH
                                            document.getElementById("loader").style.display = "none";

                                        },
                                        error: function () {
                                            alert("Whooaaa! Something went wrong..")
                                            document.getElementById("loader").style.display = "none";
                                        },
                                    });
                            }


                        }

                    }
                    },

                    //showNonCurrentDates: false,
                    eventLimit: true, // allow "more" link when too many events
                    events: allEvents,
                    eventDrop: function (event, delta, revertFunc) {

                        //alert("You change the date for the Route: " + event.title + ". The new date is: " + event.start.format());

                        if (!confirm("Are you sure about this change? All visits will change to the assigned date.")) {
                            revertFunc();
                        } else {
                            //Hacemos el callback del procedimiento que cambiara todas las fechas
                            
                        var id_route = event.title.substr(0, event.title.indexOf(' '));

                        //Guardamos en server
                        $("#loading").show();
                            $.ajax({
                                url: '/Commercial/ChangeDates',
                                type: 'POST',
                                data: { 'route': id_route, 'nuevafecha': event.start.format() },
                            cache: false,
                            global: false,
                            success: function (result) {
                                $("#loading").hide();

                                if (result.result == "success") {
                                    toastr.success("Data saved successfully.", "Success");
                                } else {
                                    revertFunc();
                                    toastr.warning(result.result, "Warning");
                                }

                            },
                            error: function (request) {
                                $("#loading").hide();
                                revertFunc();

                            }
                        });
                        }

                    },
                    eventAfterRender: function (event, element, view) {
                        //element.css("background", "#fff");
                        //element.css("border-color", "#000 !important");
                        element.css("font-size", "10px");
                        //element.css("border", "solid !important");
                    },
                    eventResize: function (event, delta, revertFunc) {
                        revertFunc();
                        //alert(event.title + "start: " + event.start.format() + " end is now " + event.end.format());

                        //if (!confirm("is this okay?")) {
                        //    revertFunc();
                        //}

                    },

                    eventClick: function (calEvent, jsEvent, view) {

                        //Llamamos con AJAX

                        var id_route = calEvent.title.substr(0, calEvent.title.indexOf(' '));

                        //Guardamos en server
                        $("#loading").show();
                        $.ajax({
                            url: '/Commercial/GetVisits',
                            type: 'GET',
                            data: { 'id': id_route },
                            cache: false,
                            global: false,
                            success: function (result) {
                                $("#loading").hide();

                                var count = 0;
                                var theDiv = document.getElementById("appendDivVisits");
                                var theDivReps = document.getElementById("appendDivReps");
                                theDiv.innerHTML = "";
                                theDivReps.innerHTML = "";

                                var porcentaje = result.porcentaje;
                                var url = '';
                                url = '<a class="text-muted" href="@Url.Action("Routes_details", "Commercial", new { id = "IDDERUTA" })">' + calEvent.title + '</a>';
                                url = url.replace('IDDERUTA', id_route);
                                var url2 = '<a class="text-muted" href="#">' + calEvent.title + '</a>'

                                if (document.getElementById("nameofroute")) {
                                    document.getElementById("nameofroute").innerHTML = url;
                                }
                                if (document.getElementById("nameofroute2")) {
                                    document.getElementById("nameofroute2").innerHTML = url2;
                                }
                                
                                document.getElementById("porcentajeroute").innerHTML = (Math.round(porcentaje * 100) / 100) + "%";
                                $("#progressbarroute").css("width", (Math.round(porcentaje * 100) / 100) + "%");

                                var contents = '';
                                $.each($.parseJSON(result.result), function (i, visitas) {
                                    count++;
                                    contents = '<div class="item-wrapper d-flex pb-4 border-bottom">';

                                    if (visitas.visitstate == 1) { //Cancelado
                                        contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-danger rounded-circle p-1 mt-2 mx-auto"></span></div>';
                                    } else if (visitas.visitstate == 2) { // En progreso
                                        contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-success rounded-circle p-1 mt-2 mx-auto"></span></div>';
                                    } else if (visitas.visitstate == 3) { //Agendado
                                        contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-warning rounded-circle p-1 mt-2 mx-auto"></span></div>';
                                    } else { //Finalizado
                                        contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-primary rounded-circle p-1 mt-2 mx-auto"></span></div>';

                                    }

                                    var url = '@Url.Action("Marketing_activities", "Commercial", new { visit= "idvisit"})';
                                  
                                    url = url.replace('idvisit', visitas.id);

                                    contents += '<div class="text-wrapper"><h6 class="d-block mb-1"><a href="' + url + '" class="text-muted">' + visitas.store + ' </a></h6><small class="text-gray d-block">' + visitas.address + '</small></div>';
                                    contents += '</div>';

                                    theDiv.innerHTML += contents;
                                });

                                var contentReps = "";
                                contentReps = '<div class="">';
                                $.each($.parseJSON(result.result2), function (i, reps) {
                                    
                                    contentReps += '<div class="text-wrapper"><h6 class="d-block mb-1"><a href="' + "#" + '" class="text-muted">- ' + reps.Name + " " + reps.LastName + ' </a></h6></div>';
                                   
                                });
                                contentReps += '</div>';
                                theDivReps.innerHTML += contentReps;

                                contents = '';
                                contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-danger rounded-circle p-1 mt-2 "></span>&nbsp; Canceled</div>';
                                contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-success rounded-circle p-1 mt-2 "></span>&nbsp; In progress</div>';
                                contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-warning rounded-circle p-1 mt-2 "></span>&nbsp; Scheduled</div>';
                                contents += '<div class="status-wrapper d-flex align-items-start pr-3"><span class="bg-primary rounded-circle p-1 mt-2 "></span>&nbsp; Finished</div>';
                                contents += '<hr>';
                   
                                theDiv.innerHTML += contents;
                                var theDivcount = document.getElementById("countVisits");
                                theDivcount.innerHTML = count;
                               
                                $('#idroutedel').data('IDr', id_route); //setter
                                $('#ID_routeD').val(id_route); //setter

                                $('#idrouteedit').data('IDr', id_route); 
                                $('#idrouteedit').data('RepeatM', result.sel); 
                            },
                            error: function (request) {
                                $("#loading").hide();


                            }
                        });
                        $("#hiddenDiv").css("display", "block");
                        // change the border color just for fun

                        if (window.mobilecheck()) {

                        } else {
                            var view = $('#calendar').fullCalendar('getView');
                 
                            if (view.name == 'listDay') {
                            } else {
                                $(".fc-h-event").css("border-color", "#eef2f5 !important");
                                $(".fc-h-event").css("background", "#eef2f5");

                                $(this).css("background", "#00ce68");
                            }
                 
                        }


  
           
                     
                    }


                })
            }
        });
    })(jQuery);


    (function ($) {
        $(function () {
            var ds = {
                'name': 'Route Day Map',
                'title': '03/25/2019',
                'children': [
                    { 'name': 'Route Name', 'title': 'Reps names' },
                    {
                        'name': 'Route Name', 'title': 'Reps names',
                        'children': [
                            { 'name': 'Visit Name', 'title': 'senior engineer' },
                            {
                                'name': 'Hei Hei', 'title': 'senior engineer',
                                'children': [
                                    { 'name': 'Pang Pang', 'title': 'engineer' },
                                    { 'name': 'Xiang Xiang', 'title': 'UE engineer' }
                                ]
                            }
                        ]
                    },
                    { 'name': 'Hong Miao', 'title': 'department manager' },
                    { 'name': 'Chun Miao', 'title': 'department manager' }
                ]
            };

            var oc = $('#chart-container').orgchart({
                'data': ds,
                'nodeContent': 'title'
            });

        });
    })(jQuery);
</script>


